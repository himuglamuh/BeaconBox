name: Build & Release BeaconBox Image

on:
  workflow_dispatch:
    inputs:
      release_date:
        description: 'Release date (YYYY-MM-DD)'
        required: false

jobs:
  build-release:
    runs-on: ubuntu-latest
    name: Build BeaconBox Image
    steps:

      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: 🐳 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🧰 Install dependencies
        run: sudo apt-get update && sudo apt-get install -y make git

      - name: 🛠 Run custom build script
        run: |
          chmod +x ./build-pi.sh
          ./build-pi.sh

      - name: 🔍 Find built image
        id: find_img
        run: |
          IMG=$(ls -t *.img | head -n 1)
          echo "image=$IMG" >> $GITHUB_OUTPUT

      - name: 🔐 Generate SHA-256 hash
        run: |
          sha256sum "${{ steps.find_img.outputs.image }}" > "${{ steps.find_img.outputs.image }}.sha256"

      - name: 📦 Upload release
        uses: softprops/action-gh-release@v2
        with:
          name: "BeaconBox Release - ${{ github.event.inputs.release_date || github.run_started_at }}"
          tag_name: "release-${{ github.event.inputs.release_date || github.run_started_at }}"
          files: |
            ${{ steps.find_img.outputs.image }}
            ${{ steps.find_img.outputs.image }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
